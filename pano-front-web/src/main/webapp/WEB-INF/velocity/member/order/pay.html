<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0">
    <title>在线支付</title>
    <link rel="stylesheet" href="/style/admstatic/css/bass.css">
    <link rel="stylesheet" href="/style/admstatic/css/index.css">
    <script src="/style/admstatic/js/main.js"></script>
    <style>
        /*在线支付-new20170826*/
        .addr .green-btn { position: fixed; bottom: 0; width: 100%; }
        .green-btn { display: block; height: 1rem; line-height: 1rem; text-align: center; background-color: #4dda65; color: #fff; font-size: .21rem; }

        .pay .row { height: .8rem; line-height: .8rem; font-size: .2rem; padding: 0;background:#fff; border-bottom: 1px solid #ddd; display: -webkit-flex; display: -moz-flex; display: flex; display: -ms-flexbox; flex-flow: row nowrap; justify-content: space-between; }
        .pay h5{height: .6rem; line-height: .6rem;background-color:#f5f5f5;padding: 0 .2rem;width: 100%; }
        .pay .row p { height: .8rem; padding: 0 .2rem;line-height:.8rem; display: -webkit-flex; display: -moz-flex;display: flex; display: -ms-flexbox; flex-flow: row nowrap; justify-content: space-between; align-items: center;}
        .pay .row span.block { display: block; }
        .pay .row .square { width: .3rem; height: .3rem; line-height: .3rem; text-align: center; background-color: #f6f6f6; margin: 0 .05rem; }
        .pay .z-pay img {width: .5rem; height: .5rem;margin-right:.2rem;}
        .z-choose { width:.6rem; height: .6rem; background: url(/images/member/order/paychoose2.png) 0/cover;margin: .1rem;}
        .z-choose2 { width:.6rem; height: .6rem; background: url(/images/member/order/paychoose.png) 0/cover;margin: .1rem;}
        .z-choose img { width: 1.5rem; height: 1.5rem; }
   
   /*银行卡信息输入*/
        .yanz{ width: 100%; background-color: #fff; padding: .3rem; position: fixed; bottom:0;}
        .yanz .row{ line-height: .8rem; border-bottom: 1px solid #eee; }
        .yanz .row i{ font-size: 0.4rem; vertical-align: middle; }
        .yanz button{ margin: .4rem 0; width: 100%; height: .7rem; font-size: .25rem; background: #000; color: #fff; border: .02rem solid #fff; border-radius: .1rem; cursor: pointer; }
        .yanz input[type=text], #confirm input[type=text] { width: 50%; }
        
    </style>
    <script type="text/javascript">
    function get_querystring(name)
    {
         var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
         var r = window.location.search.substr(1).match(reg);
         if(r!=null)return  unescape(r[2]); return null;
    }
    
    var orderSn = $!orderSn;
    var payAmount = $!order.payMoney;
   
 
    	var pay_type="LIANPAY";
    	function pay(){
    		if(!pay_type){
    			alert('请选择支付方式')
    			return;
    		}
    		$.ajax({
                type: 'POST',
                async: false,
                data: {order_sn:orderSn,pay_type:pay_type,card_no:$('#user_bankcard_cartno').val(),id_no:$('#user_bankcard_certno').val(),acct_name:$('#user_bankcard_username').val(),user_bankcard_sn:$('#user_bankcard_sn').val()},
                url: '/order/pay',
                dataType: 'json',
                success: function (data) {
                	if(data.status != 0){
                		if(!data.unPayedParentOrderSn){
                			alert(data.statusMsg)
                		}else{
                			alert(data.statusMsg)
                		}
                		return;
                	}else{
                		if(pay_type=='LIANPAY'){
                			$('#lianpay [name=req_data]').val(data.linkString);
                			$('#lianpay').attr("action",data.outGateway);
                			$('#lianpay').submit();
                		}else if(pay_type=='WXOFFICIAL'){
                			onBridgeReady(data.appId,data.timeStamp,data.nonceStr,data.pack,data.paySign,data.returnUrl);
                		}
                	}
                },
                error:function(xhr,textStatus){
        	    	if(xhr.getResponseHeader('sessionstatus') === "timeout"){
        	    		window.location.href = "/member/login/nomal";
        	    	}
        	    }
            })
    		 
    	}
    	$('.yanz').hide();
    	choose_paytype('LIANPAY')
    	function choose_paytype(pay_type_param,event){
    		var targetClass;
    		if('LIANPAY' == pay_type_param){
    			pay_type = "LIANPAY";
    			$('.yanz').show();
    		}else if('WX' == pay_type_param){
	    			if(navigator.userAgent.indexOf("MicroMessenger") !=-1){
	    				pay_type = "WXOFFICIAL";
	    				$('.yanz').hide();
	    			}else{
	        			alert("请在微信内打开该网页");
	        			return;
	        		}
    		}
    		$('.pay .row .tick').removeClass('z-choose2');
    		$('.pay .row .tick').addClass('z-choose');
    		$('.pay .'+pay_type_param+' .tick').addClass('z-choose2');
    	}
    	
    	//微信支付JSSDK
		function onBridgeReady(appId,timeStamp,nonceStr,pack,paySign,returnUrl){
		    WeixinJSBridge.invoke(
		        'getBrandWCPayRequest', {
		            "appId" : appId,     //公众号名称，由商户传入
		            "timeStamp":timeStamp,         //时间戳，自1970年以来的秒数
		            "nonceStr" : nonceStr, //随机串
		            "package" : pack,
		            "signType" : "MD5",         //微信签名方式：
		            "paySign" : paySign //微信签名
		        },
		        function(res){
		            if(res.err_msg == "get_brand_wcpay_request:ok" ) {
		                window.location.href=returnUrl;
		            }     // 使用以上方式判断前端返回,微信团队郑重提示：res.err_msg将在用户支付成功后返回    ok，但并不保证它绝对可靠。
		        }
		    );
		}
    </script>
</head>

<body>

<form id="lianpay" action="" method="get" hidden>
				<ul>
					<li><input type="hidden" name="req_data" value='' />
						<button name="next_btn" class="btn" type="submit" id="next_btn">连连支付</button></li>
				</ul>
			</form>
<div class="container addr">
    <!--图片-->
    <section class="addr-section">
        <div class="pay">
			<div style="background-color:white;height:50px;font-size:17px;padding:12px 15px;"><span style="">订单总额</span><span style="float:right">¥: $!order.sumMoney</span></div>
                <h5>选择支付方式</h5>

          <!--   <div class="row ALIPAY" onclick="choose_paytype('ALIPAY',event)">
                <p><i class="z-pay"><img src="/images/member/order/z-pay.png" alt="" ></i>支付宝</p><div class="tick z-choose"></div>
            </div> -->
            <div class="row LIANPAY" onclick="choose_paytype('LIANPAY',event)">
                <p><i class="z-pay"><img src="/images/member/order/y-pay.png" alt="" ></i>银行卡支付</p><div class="tick z-choose2"></div>
            </div>
            <div class="row WX" onclick="choose_paytype('WX',event)">
                <p><i class="z-pay"><img src="/images/member/order/w-pay.png" alt="" ></i>微信支付</p><div class="tick z-choose"></div>
            </div>
          		
        </div>
    </section>
    <a class="green-btn bcdz" onclick="pay()" style="z-index:1">
        确认支付￥<span class="pay_amount">$!order.payMoney</span>
    </a>

</div>

 <div class="yanz" >
            <form action="">
            <input hidden id="user_bankcard_sn" value="$!userBankcard.sn" /> 
                <div class="row">
                    <input  type="name" placeholder="请输入姓名" id="user_bankcard_username" value="$!userBankcard.userName">
                </div>
                <div class="row">
                    <input  type="sfz" placeholder="请输入身份证号" id="user_bankcard_certno" value="$!userBankcard.certNo">
                </div>
                <div class="row">
                    <input  type="yhk" placeholder="请输入银行卡号" id="user_bankcard_cartno" value="$!userBankcard.cardNo">
                </div>
            </form>
            <div style="height:50px;z-index:0"></div>
        </div>

</body>
</html>