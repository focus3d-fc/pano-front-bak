#set($layout = "layout/member/layout.html")
<link rel="stylesheet" href="/style/admstatic/css/bass.css">
<link rel="stylesheet" href="/style/admstatic/css/index.css">
<script type="text/javascript" src="/style/admstatic/js/getVerifyCode.js"></script>
<script src="/style/admstatic/js/main.js"></script>
<div class="container confirm">

    <!--列表头-->
    <section class="address">
        <img src="../image/img/8.png" alt="">
        <div>
            <p class="clearfix">
                <span class="fl">收货人：$!defaultAddress.userName</span>
                <span class="fr">$!defaultAddress.mobile</span>
            </p>
            <p>
                收货地址：$!defaultAddress.province $!defaultAddress.province.city $!defaultAddress.province.area $!defaultAddress.province.street
            </p>
        </div>
        <a href="address.html" class="right"><i class="iconfont">&#xe6c7;</i></a>
    </section>
    <!--订单-->
    <section class="order-items">
    #foreach($!housePackage in $!housePackages)
      <div class="order-item" id="$!housePackage.sn">
          <div class="title">
              <div>
                  <img src="../image/img/30.png" alt="">
                  基础套餐
              </div>
              <span class="red">
                  等待买家付款
              </span>
          </div>
          <div class="cont">
              <a href="#"><img src="$!fs.url($!housePackage.imgSn)" ></a>
              <div class="detail">
                  <a href="#"><p class="detail-tlt">$!housePackage.style.name $!housePackage.house.name</p></a>
                  <p class="col detail-con">$!housePackage.name</p>
              </div>
              <div class="price">
                  <p class="red">￥<span class='price_val'>$!housePackage.packagePrice</span></p>
                  <s class="col">￥$!housePackage.discountPrice</s>
                  <p class="col">×<span>1</span></p>
              </div>
          </div>
          <div class="row">
           <p>购买数量</p>
          <p>
              <span class="square" onclick="subCount('$!housePackage.sn')">-</span>
              <span class="buyCount">1</span>
              <span class="square" onclick="addCount('$!housePackage.sn')">+</span>
          </p>
          </div>
         
         
          </div>
           #end
            <div class="row">
              <p>请输入兑换优惠码：</p>
              <p  class="couponCodeSquares" onclick="$('[name=couponCode]').focus();"><input  type="number"  maxlength='6' style="outline:medium;color:transparent;border:none;" name="couponCode"  />
                  <span class="square"></span>
                  <span class="square"></span>
                  <span class="square"></span>
                  <span class="square"></span>
                  <span class="square"></span>
                  <span class="square"></span>
              </p>
          </div>
		         <div class="row noboder">
		              <p>付款方式：</p>
		          </div>
		          <p>
		              <a href="#" class="paying" onclick="choosePayScheme(1)">付全款
		                  <span class="red">95折</span>
		            </a>
		              <a href="#" class="paid" onclick="choosePayScheme(2)">预付2成</a>
		          </p>
		          <div class="stages" style="display:none;">
		          	<div><span>阶段1：定金</span><span style="margin-left:40px;">优惠券抵扣：￥<span class="couponAmount"></span></span><span style="margin-left:40px;">小计：￥<span class="stage1Amount"></span></span></div>
		          	<div><span>阶段2：尾款</span><span style="margin-left:40px;">小计：￥<span class="stage2Amount"></span></div>
		          	<div></div>
		          </div>
		          <div class="row2">
		              <p>
		                  <img src="../image/img/choose2.png" alt="">
		                  <a onclick="$('.wrap').show();" >我已阅读并同意
		                      <span class="red">合同条款</span>
		                  </a>
		              </p>
		          </div>
		          <div class="total">
		              共 <span class="totalCount"></span>件产品 <span class="payAmountDesc">合计</span>￥<span class="red"></span>元
		              <a class="tj" onclick="$('.wrap1').show();">
		                  提交订单
		              </a>
		          </div>
      
    </section>
     
</div>
<!--合同条款弹窗-->
<div class="wrap">
    <div id="agree">
        <h3>合同条款</h3>
        <p>
            我是条款我是条款我是条款我是条款我是条款我是条款我是条款我是条款我是条款我是条款我是条款我是条款我是条款我是条款我是条款我是条款
            我是条款我是条款我是条款我是条款我是条款我是条款我是条款我是条款我是条款我是条款我是条款我是条款我是条款我是条款我是条款我是条款
            我是条款我是条款我是条款我是条款我是条款我是条款我是条款我是条款我是条款我是条款我是条款我是条款我是条款我是条款我是条款我是条款
        </p>
        <div>
            <a href="#" class="paid" onclick="$('.wrap').hide();"> 我已阅读</a>
        </div>
    </div>
</div>
<!--提交订单弹窗-->
<div class="wrap1">
    <div id="confirm">
        <form action="">
            <div class="confirm-title">
                输入下列验证码意味着您确认合同内容并且签署此合同
                <div class="confirm-close">
                    <i class="iconfont">&#xe70c;</i>
                </div>
            </div>
            <div class="row">
                <i class=" iconfont">&#xe61b;</i>
                <input type="tel" placeholder="请输入手机号" id="j_phone">
            </div>
            <div class="row">
                <i class=" iconfont">&#xe66f;</i>
                <input type="text" placeholder="验证码">
                <span id="j_getVerifyCode">获取验证码</span>
            </div>
            <button type="submit">立即验证</button>
        </form>
    </div>
</div>
<!--注册验证-->
<script>
var payScheme=1;
var payAmount = 0;
var couponAmount = 0;
var couponCode = null;

var packages = new Object();

#foreach($!housePackage in $!housePackages)
packages['$!housePackage.sn'] = new Object();
	packages['$!housePackage.sn'].price=$!housePackage.packagePrice
	packages['$!housePackage.sn'].count=1
#end

calculate();
	
function calculate(){
	payAmount  =0;
	var totalCount = 0;
	for(var i in packages){
        if (packages.hasOwnProperty(i)) { //filter,只输出man的私有属性
        	payAmount = payAmount+(packages[i].price*packages[i].count)
        	totalCount = totalCount+ packages[i].count;
        };
    }
	payAmount = payAmount - couponAmount;
	if(payScheme == 1){
		
		$('.total .red').text(payAmount)
		$('.total .totalCount').text(totalCount)
		$('.payAmountDesc').text('合计')
	}else{
		var stage1Amount = payAmount*0.2;
		stage1Amount= parseFloat(stage1Amount.toFixed(2))
		var stage2Amount = payAmount - stage1Amount;
		payAmount=stage1Amount;
		$('.total .red').text(payAmount)
		$('.total .totalCount').text(totalCount)
		$('.couponAmount').text(couponAmount)
		$('.stage1Amount').text(stage1Amount)
		$('.stage2Amount').text(stage2Amount)
		$('.payAmountDesc').text('定金')
		
		
	}
}

function choosePayScheme(paySchemeParam){
	payScheme = paySchemeParam;
	if(payScheme== 1){
		$('.stages').hide();
	}else{
		$('.stages').show();
	}
	
	calculate();
}
    //获取手机验证码-登录
    $("#j_getVerifyCode").on("click",getVerifyCode({
        callBack: function (){//按钮点击后的回调函数，-----必须-----
            //在这里你还是可以对你的按钮进行操作
            alert("验证码发送成功");
        },
        time: 60,//定时时间，以秒为单位，默认60秒
        getCurrentTime: function (time){//获取倒计时当前时间
        },
        isPhone: true,//是否为发送手机验证码，如果是则会验证手机号格式，-----必须-----
        getPhone: function (){//获取手机号，此+处一定要return
            return $("#j_phone").val();
        },
        phoneReg: /^1[34578]\d{9}$/,//手机号验证正则
        phoneCallBack: function (){//当手机号有误时的回调，默认会中止操作
            alert("您输入的手机号有误");
        },
        timeIsUpText: "重新发送",//倒计时时间到了后按钮所显示文字
        timeRunnigText: "s后重新发送",//倒计时时间正在走的时候按钮所显示文字。默认为"xxs后重新获取"
        unabledClass: "unlabed"//按钮不能用的样式，即点击按钮后的样式
    }));

//    点击确认订单消失
    $(function(){
        $(".wrap1").click(function(){
            $(".wrap1").hide();
            return false;
        })
        $("#confirm").click(function(){
            return false;
        })
        
        	$('[name=couponCode]').blur(function(event){
        		if(event.target.value && event.target.value.length==6){
        		$.ajax({
                    type: 'GET',
                    async: false,
                    data: {},
                    url: '/order/coupon?code='+event.target.value,
                    dataType: 'json',
                    success: function (data) {
                    	if(!data.discountAmount)
                    		alert('未找到该优惠券')
                        if(data.status == 1){
                        	alert('优惠券未生效')
                        }else if(data.status == 2){
                        	alert('优惠券过期')
                        }else{
                        	couponAmount = data.discountAmount;
                        	couponCode = event.target.value;
                        }
                        
                    },
                    error:function(xhr, msg, reasonString){
                        alert('优惠券获取失败')
                    }
                });
        		}
        	})
        $('[name=couponCode]').keydown(function(event){ 
        	$($('[name=couponCode]').nextAll('span.square')).each(function(index,ele){
        		if($(ele).text() == ''){
        			$(ele).text(String.fromCharCode(event.which))
        			return false;
        		}
        		
        	})
        	if($('[name=couponCode]').val().length==6){
        		$('[name=couponCode]').blur();
        	}
        }
        );
    })
    
    function subCount(packageId){
		var count = parseInt($('#'+packageId+' .buyCount').text())-1;
	if(count >= 1){
		$('#'+packageId+' .buyCount').text(count)
		//$('.total .red').text(parseInt($('.total .red').text())-parseInt( $('#'+packageId+' .price .red .price_val').text()))
		packages[packageId].count=count
		calculate()
	}
	 
   }
   
    function addCount(packageId){
		var count = parseInt($('#'+packageId+' .buyCount').text())+1;
		//$('.total .red').text(parseInt($('.total .red').text())+parseInt($('#'+packageId+' .price .red .price_val').text()))
		$('#'+packageId+' .buyCount').text(count)
		packages[packageId].count=count
		calculate()
   }
    
    
</script>
